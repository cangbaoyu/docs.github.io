import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,e as l,o as e}from"./app-gMUC0DCo.js";const n={};function h(t,i){return e(),a("div",null,i[0]||(i[0]=[l(`<h1 id="mysql备份策略" tabindex="-1"><a class="header-anchor" href="#mysql备份策略"><span>MySQL备份策略</span></a></h1><h2 id="_1-概述" tabindex="-1"><a class="header-anchor" href="#_1-概述"><span>1. 概述</span></a></h2><p>根据墨菲定律，数据库在运行过程中，终会遇到各种各样的问题: 硬件故障、Bug 导致数据损坏、由于服务器宕机或者其他原因造成的数据库不可用。 如果有 DBA 告诉你，这个数据库能够恢复到两个个月内任何状态，这说明了，这个数据库的 binlog 日志至少保留了两个月。备份 binlog 的好处:</p><ul><li>可以实现基于任意时间点的恢复</li><li>可以用于误操作数据闪回</li><li>可以用于审计 当你要进行数据恢复的时候，就会非常庆幸有做 <code>binlog</code> 备份。当然，使用 <code>binlog</code> 恢复数据的前提是 <code>binlog</code> 格式要设为 <code>row</code>，不要担心空间问题，当前最不缺的资源就是硬盘空间。对于 <code>binlog</code>，推荐的配置是</li></ul><div class="language-ini line-numbers-mode" data-highlighter="shiki" data-ext="ini" data-title="ini" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 记录每一行数据的变化</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD;">binlog_format</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;"> row</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 备库在重做数据的时候，记录一条 binlog</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#C678DD;">log_slave_updates</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#98C379;"> 1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="有哪些备份方式" tabindex="-1"><a class="header-anchor" href="#有哪些备份方式"><span>有哪些备份方式</span></a></h3><blockquote><p><strong><code>逻辑备份</code></strong> : 逻辑备份是最常见的方式，在数据量比较少的时候很常用。</p><ul><li><code>优点</code>： <ol><li>备份恢复比较简单，例如 <code>mysqldump</code> 就是 MySQL 自带的备份工作，无需额外安装。恢复的时候可以直接使用 <code>mysql</code> 命令进行恢复。</li><li>可以远程备份和恢复，也就是说，可以在其他机器执行备份命令。</li><li>备份出来的数据非常直观，备份出来后，可以使用 <code>sed</code> <code>grep</code> 等工具进行数据提取或者修改。</li><li>与存储引擎无关，因为备份文件是直接从 MySQL 里面提取出来的数据，所以在直观上，备份数据数据不对引擎做区分，可以很方便地从 <code>MyISAM</code> 引擎改到 <code>InnoDB</code> 引擎。</li><li>避免受到文件损坏的影响，如果直接复制原始文件，可能会受到某个文件损坏的影响而得到一个损坏的备份。使用逻辑备份，只要 MySQL 还能执行 SELECT 语句，就可以得到一份可以信赖的逻辑备份，在文件损坏的时候很有用。</li></ol></li><li><code>缺点</code>： <ol><li>因为必须使用 MySQL 服务进行数据操作，所以备份的时候会占用更多 CPU，且备份时间可能会更长。</li><li>逻辑备份在某些场景下比数据库文件更大，文本存储的数据不总是比存储引擎更高效。当然，使用压缩的话会得到一个更小的备份，但是要占用 CPU 资源。（如果索引较多，逻辑备份会比物理备份小。）</li><li>恢复时间更长，使用逻辑备份的数据恢复，需要占用更多资源去进行锁分配、索引构建、冲突检查、日志刷新。</li></ol></li><li><code>常用方法</code>： <ol><li><code>mysqldump</code> 是 <code>MySQL</code>自带的备份工具，通用性强，非常常见。使用的使用通常要加上一些参数，后面继续介绍。</li><li><code>select into outfile</code>，以符号分割数据创建逻辑备份，对于要导入到 <code>CSV</code> 等表格会比较实用。</li><li><code>mydumper</code>，允许使用多线程进行备份，备份文件会进行表结构和数据分离，在恢复某些表或数据的时候会非常有效。</li></ol></li></ul></blockquote><hr><blockquote><p><strong><code>物理备份</code></strong>: 物理备份在数据量较大的时候非常常见。</p><ul><li><p><code>优点</code>：</p><ol><li>备份速度快，因为物理备份是基于复制进行备份，意味者复制有多快，备份就能有多快。</li><li>恢复速度快，只需要把文件复制到数据库目录就可以完成恢复，不需要检查锁、构建索引。</li><li>恢复简单，对于 MySIAM 引擎的表，不需要停库，只需要简单地复制进数据目录就可以。对于 InnoDB，如果是每个表一个表空间，也可以不停库操作，使用卸载加载表空间的方式便可导入（不太安全）。</li></ol></li><li><p><code>缺点</code>：</p><ol><li>没有官方物理热备份工具的支持。没有官方工具的支持，意味着出问题的概率较大，使用的时候就要谨慎了</li><li>InnoDB 的原始文件通常比逻辑备份要大。InnoDB 表空间往往包含很多未被使用的空间，InnoDB 表在删除数据后不会释放空间，所以即使数据量不大，文件有可能很大。除此以外，文件中除了数据还包含了索引、日志等信息。</li><li>物理备份不总可以跨平台跨版本。MySQL 文件和操作系统、MySQL 版本息息相关，如果环境与原来不一致，很有可能会出现问题。</li></ol></li><li><p><code>常用方法</code>：</p><ol><li><code>xtrabackup</code> 是最常用的物理备份工具，由 <code>percona</code> 开源，能够实现对 InnoDB 存储引擎和 XtraDB 存储引擎非阻塞地备份（对于 MyISAM 还是要加锁），得到一份一致性备份。</li><li><code>直接复制文件/文件系统快照</code>，这种方式对于 <code>MySIAM</code> 引擎是非常高效的，只需要执行 <code>FLUSH TABLE WITH READ LOCK</code> 就可以复制得到一份备份文件。但是对于 <code>InnoDB</code> 引擎就比较困难，因为 <code>InnoDB</code> 引擎使用了大量的异步技术，即使执行了 <code>FLUSH TABLE WITH READ LOCK</code>，它还是会继续合并日志、缓存数据。所以要用这种方法备份 <code>InnoDB</code>，需要确保 <code>checkpoint</code> 已经最新。</li></ol></li></ul></blockquote><h2 id="_2-全量备份" tabindex="-1"><a class="header-anchor" href="#_2-全量备份"><span>2. 全量备份</span></a></h2><p>全量备份介绍最常用的逻辑备份工具 <code>mysqldump</code> 和物理备份工具 <code>xtrabackup</code>。如果对 <code>mysqldump</code> 不太满意 可以使用 <code>mydumper</code> 来替代 <code>mysqldump</code>。</p><h3 id="_2-1-mysqldump" tabindex="-1"><a class="header-anchor" href="#_2-1-mysqldump"><span>2.1 mysqldump</span></a></h3><p><code>mysqldump</code> 是用得最多的工具，需要增加一些额外的参数。<code>mysqldump</code> 有很多可用参数，建议直接访问官网 <a href="https://link.segmentfault.com/?enc=kDGBSqEshWDPuY4pUtZlVQ%3D%3D.G9G1LVS%2Fw0QMpAJAsjhGpAmDcStIkffhGiulkdIMNRcpenbrCy%2FF%2F3Vkma1G%2FlW2xs2CKAz4NPsjkpky0oUYfg%3D%3D" target="_blank" rel="noopener noreferrer">mysqldump</a>。使用 <code>mysqldump</code> 某些参数需要 <code>select,reload,lock tables</code> 权限。</p><h4 id="innodb-全库备份" tabindex="-1"><a class="header-anchor" href="#innodb-全库备份"><span>InnoDB 全库备份</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mysqldump</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --opt</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --single-transaction</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --master-data=2</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --default-character-set=utf8</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">host</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -u</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">password</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">backup.sql</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>--opt</code> 如果有这个参数表示同时激活了mysqldump命令的quick，add-drop-table，add-locks，extended-insert，lock-tables参数，它可以给出很快的转储操作并产生一个可以很快装入MySQL服务器的转储文件。当备份大表时，这个参数可以防止占用过多内存</li><li><code>--single-transaction</code> 设置事务的隔离级别为可重复读，然后备份的时候开启事务，这样能保证在一个事务中所有相同的查询读取到同样的数据。注意，这个参数只对支持事务的引擎有效，如果有 <code>MyISAM</code> 的数据表，并不能保证数据一致性</li><li><code>-A</code> 导出全部数据库</li><li><code>–-default-character-set=charset</code> 指定导出数据时采用何种字符集</li><li><code>--master-data=2</code> 表示在备份过程中记录主库的 <code>binlog</code> 和 <code>pos</code> 点，并在dump文件中注释掉这一行，在使用备份文件做新备库时会用到</li></ul><h4 id="myisam-全库备份" tabindex="-1"><a class="header-anchor" href="#myisam-全库备份"><span>MyISAM 全库备份</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mysqldump</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --opt</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --lock-all-tables</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --master-data=2</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --default-character-set=utf8</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">host</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -u</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">password</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">backup.sql</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>--lock-all-tables</code> 锁表备份。由于 <code>MyISAM</code> 不能提供一致性读，如果要得到一份一致性备份，只能进行全表锁定。</li></ul><h4 id="备份带上压缩" tabindex="-1"><a class="header-anchor" href="#备份带上压缩"><span>备份带上压缩</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mysqldump</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">host</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -u</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">password</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> | </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">gzip</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &gt;&gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">backup.sql.gz</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="备份多个库" tabindex="-1"><a class="header-anchor" href="#备份多个库"><span>备份多个库</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mysqldump</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">host</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -u</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">password</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --databases</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">dbname</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">1&gt; &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">dbname</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">2&gt; &gt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">backup.sql</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="恢复" tabindex="-1"><a class="header-anchor" href="#恢复"><span>恢复</span></a></h4><p>恢复方式比较简单，直接执行 sql 语句就可以了</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mysql</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -h</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">host</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -u</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">password</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt; </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">backup.sql</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="mysqldump执行流程" tabindex="-1"><a class="header-anchor" href="#mysqldump执行流程"><span>mysqldump执行流程</span></a></h4><p>打开 <code>general_log</code> 可以查看 <code>mysqldump</code> 的执行流程，这里以 <code>--single-transaction --opt -A</code> 参数为例</p><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">FLUSH </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">/*!40101 LOCAL */</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> TABLES</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">FLUSH TABLES </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">WITH</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> READ</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> LOCK</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SET</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> SESSION</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> TRANSACTION</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ISOLATION</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> LEVEL</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> REPEATABLE</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> READ</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">START TRANSACTION</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">SHOW VARIABLES </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">LIKE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;gtid\\_mode&#39;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">SHOW </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">MASTER</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> STATUS</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">UNLOCK</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> TABLES</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">SHOW </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">CREATE</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> DATABASE</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> IF</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> NOT</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> EXISTS</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> \`employees\`</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">SAVEPOINT sp</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SELECT</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> /*!40001 SQL_NO_CACHE */</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> * </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">FROM</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> \`departments\`</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">....</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-xtrabackup" tabindex="-1"><a class="header-anchor" href="#_2-2-xtrabackup"><span>2.2 xtrabackup</span></a></h3><h4 id="安装方式" tabindex="-1"><a class="header-anchor" href="#安装方式"><span>安装方式</span></a></h4><p>更多安装方式参考官网 <a href="https://www.percona.com/doc/percona-xtrabackup/8.0/index.html" target="_blank" rel="noopener noreferrer">xtrabackup</a> 这里我们使用 <code>rpm</code> 安装的方式</p><div class="language-apache line-numbers-mode" data-highlighter="shiki" data-ext="apache" data-title="apache" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">yum install http://www.percona.com/downloads/percona-release/redhat/</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">6</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">/percona-release-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">6</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.noarch.rpm</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">yum update percona-release</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># qpress 用作压缩解压</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">yum install percona-xtrabackup-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">24</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> qpress</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="使用方法" tabindex="-1"><a class="header-anchor" href="#使用方法"><span>使用方法</span></a></h4><h4 id="增加备份账号并授权" tabindex="-1"><a class="header-anchor" href="#增加备份账号并授权"><span>增加备份账号并授权</span></a></h4><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" data-title="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">CREATE</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> USER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &#39;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">backup</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&#39;@</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;localhost&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> IDENTIFIED </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">BY</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;backup&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">GRANT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> PROCESS,RELOAD, LOCK TABLES, REPLICATION CLIENT </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">ON</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> *.* </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">TO</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &#39;backup&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">@</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;localhost&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">FLUSH PRIVILEGES;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="全备" tabindex="-1"><a class="header-anchor" href="#全备"><span>全备</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">innobackupex</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --defaults-file=/etc/my.cnf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --user=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --password=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">pwd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">要备份到哪个目</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">录&gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">--no-timestamp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --compress</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --compress-threads=4</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --parallel=4</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><code>--no-timestamp</code> 不使用当前时间建立文件夹。默认情况下会在备份目录以当前时间创建文件夹</li><li><code>--compress</code> 压缩</li><li><code>--compress-threads=N</code> 压缩线程</li><li><code>--parallel=N</code> 备份线程</li></ul><h4 id="恢复-1" tabindex="-1"><a class="header-anchor" href="#恢复-1"><span>恢复</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 步骤一：解压</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">innobackupex</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --decompress</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">备份文件所在目</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">录&gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">--parallel=4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 步骤二：应用日志</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">innobackupex</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --apply-log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">备份文件所在目</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">录&gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">--parallel=4</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 步骤三：复制备份文件到数据目录</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">innobackupex</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --datadir=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">MySQL数据目录</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --copy-back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">备份文件所在目</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">录&gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">--parallel=4</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-增量备份" tabindex="-1"><a class="header-anchor" href="#_3-增量备份"><span>3. 增量备份</span></a></h2><p>当数据了变得庞大时，一个常见策略就是做定期的增量备份。例如：周一做了一次全量备份，然后周二到日做增量备份。 增量备份只包含变化的数据集，一般情况不会比原始数据量大，所以可以减少服务器的开销、备份时间、备份空间。 当然，使用增量备份也会有风险，增量备份每一次迭代都是基于上一次的备份实现，意味着只要其中一份备份出现问题，那么就有可能导致所有备份不可用。</p><h3 id="_3-1-使用-xtrabackup-做增量备份" tabindex="-1"><a class="header-anchor" href="#_3-1-使用-xtrabackup-做增量备份"><span>3.1 使用 xtrabackup 做增量备份</span></a></h3><p>xtrabackup 允许进行增量备份，命令如下:</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">innobackupex</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --defaults-file=/etc/my.cnf</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --user=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">user</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --password=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">pwd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --no-timestamp</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --compress</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --incremental</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --incremental-basedir=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">全量备份的目录</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">要增量备份到什么目</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">录&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>恢复：</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 步骤一：对全备解压</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">innobackupex</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --decompress</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">全量备份文件所在目</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">录&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 步骤二：对全备应用日志</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">innobackupex</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --apply-log</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --redo-only</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">全量备份文件所在目</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">录&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 步骤三：对增量备份进行解压</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">innobackupex</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --decompress</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">增量文件所在目</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">录&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 步骤四：合并增量数据</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">innobackupex</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --apply-log</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --redo-only</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --incremental</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">全量备份文件所在目</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">录&gt; </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">--incremental-dir=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">增量文件所在目录</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 步骤五：对合并后的数据应用日志</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">innobackupex</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --apply-log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">全量备份文件所在目</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">录&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 步骤六：复制备份文件到数据目录</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">innobackupex</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --datadir=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">MySQL数据目录</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> --copy-back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> &lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">全量备份文件所在目</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">录&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-使用-binlog-做增量备份" tabindex="-1"><a class="header-anchor" href="#_3-2-使用-binlog-做增量备份"><span>3.2 使用 binlog 做增量备份</span></a></h3><p>使用 <code>binlog</code> 做增量备份比较简单，备份的时候执行 <code>FLUSH LOGS</code> 轮转日志，然后把旧的 <code>binlog</code> 复制到备份目录就可以了。 恢复的时候使用 <code>mysqlbinlog --start-position=&lt;备份集的pos点&gt; binlog日志 | mysql -u&lt;user&gt; -p</code> 就可以了</p><h2 id="_4-延迟同步" tabindex="-1"><a class="header-anchor" href="#_4-延迟同步"><span>4. 延迟同步</span></a></h2><p>延迟同步是常见的使用主从复制使用模式，在遇到误操作的时候，无论是用于恢复数据，还是使用跳过的方式跳过错误都是非常有用。 例如在主库做了 <code>drop</code> 的误操作，在主库找到命令所在 binlog 日志和 pos 位置，Delay库停止同步， 然后使用 <code>start slave until master_log_file=&#39;&lt;对应file&gt;&#39;,master_log_pos=&lt;误操作命令前一个SQL的pos&gt;;</code> 等待同步到这个位置，执行跳过一条 SQL 的命令再开启同步。 常见的延迟同步复制模式有: 一主带三从</p><figure><img src="https://segmentfault.com/img/bVbvTuo?w=333&amp;h=318" alt="图片描述" tabindex="0" loading="lazy"><figcaption>图片描述</figcaption></figure><p>有时候为了减少主库压力，会把延迟库放在备节点之后</p><figure><img src="https://segmentfault.com/img/bVbvTun?w=333&amp;h=321" alt="图片描述" tabindex="0" loading="lazy"><figcaption>图片描述</figcaption></figure><p>延迟同步开启方式如下:</p><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">stop</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> slave</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">CHANGE</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> MASTER</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> TO</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> MASTER_DELAY</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> =</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> N秒</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">start</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> slave</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-数据校验" tabindex="-1"><a class="header-anchor" href="#_5-数据校验"><span>5. 数据校验</span></a></h2><p>除了备份，非常重要的一件事情就是验证备份数据的可用性。想象一下，当你需要进行数据恢复的时候，忽然发现过去的备份数据都是无效的，那得有多难受。很多朋友在写好备份脚本加到定时任务后，只要检查到定时任务有执行，备份目录有文件就不再关注了，往往到了需要使用备份文件的时候才发现备份数据有问题。</p><p>目前对于备份文件的数据校验没有非常方便的办法，用的比较多的还是定时把备份文件拉出来做备份恢复演练，例如一个月做一次备份恢复演练就可以有效提高备份文件可用性，心里也踏实。</p><p>数据校验部分，如果是逻辑备份，往往会抽查某个表的数据，检查是否符合预期。如果是物理备份，首先要使用 <code>mysqlcheck</code> 等命令检查是否有表损坏，没有损坏再抽查表数据。</p><h2 id="_6-总结" tabindex="-1"><a class="header-anchor" href="#_6-总结"><span>6. 总结</span></a></h2><ol><li>逻辑备份和物理备份可以一起使用，不同的备份周期使用不同的工具，全备周期不应该太长，至少一周一次全备</li><li>如果数据量较大，可以使用增量备份的方式减少数据量，要注意的是，增量备份风险更大</li><li>binlog功能要开启，设为 <code>row</code> 模式，设置 <code>log_slave_updates = 1</code>，且最好定时备份 binlog</li><li>有条件的话可以增加一个 Delay 库，在做紧急恢复的时候有奇效</li><li>数据校验要定时去做，否则当需要备份恢复的时候而备份文件又失效，后悔都来不及</li></ol><blockquote><p>参考资料: - 高性能MySQL（第3版）</p></blockquote>`,64)]))}const d=s(n,[["render",h]]),r=JSON.parse('{"path":"/notebook/mysql/MySQL%E5%A4%87%E4%BB%BD%E7%AD%96%E7%95%A5.html","title":"MySQL备份策略","lang":"zh-CN","frontmatter":{"description":"MySQL备份策略 1. 概述 根据墨菲定律，数据库在运行过程中，终会遇到各种各样的问题: 硬件故障、Bug 导致数据损坏、由于服务器宕机或者其他原因造成的数据库不可用。 如果有 DBA 告诉你，这个数据库能够恢复到两个个月内任何状态，这说明了，这个数据库的 binlog 日志至少保留了两个月。备份 binlog 的好处: 可以实现基于任意时间点的恢复...","head":[["meta",{"property":"og:url","content":"https://www.sansei.top/notebook/mysql/MySQL%E5%A4%87%E4%BB%BD%E7%AD%96%E7%95%A5.html"}],["meta",{"property":"og:site_name","content":"川上富江"}],["meta",{"property":"og:title","content":"MySQL备份策略"}],["meta",{"property":"og:description","content":"MySQL备份策略 1. 概述 根据墨菲定律，数据库在运行过程中，终会遇到各种各样的问题: 硬件故障、Bug 导致数据损坏、由于服务器宕机或者其他原因造成的数据库不可用。 如果有 DBA 告诉你，这个数据库能够恢复到两个个月内任何状态，这说明了，这个数据库的 binlog 日志至少保留了两个月。备份 binlog 的好处: 可以实现基于任意时间点的恢复..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://segmentfault.com/img/bVbvTuo?w=333&h=318"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-08-05T15:52:57.000Z"}],["meta",{"property":"article:modified_time","content":"2025-08-05T15:52:57.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"MySQL备份策略\\",\\"image\\":[\\"https://segmentfault.com/img/bVbvTuo?w=333&h=318\\",\\"https://segmentfault.com/img/bVbvTun?w=333&h=321\\"],\\"dateModified\\":\\"2025-08-05T15:52:57.000Z\\",\\"author\\":[]}"]]},"headers":[{"level":2,"title":"1. 概述","slug":"_1-概述","link":"#_1-概述","children":[{"level":3,"title":"有哪些备份方式","slug":"有哪些备份方式","link":"#有哪些备份方式","children":[]}]},{"level":2,"title":"2. 全量备份","slug":"_2-全量备份","link":"#_2-全量备份","children":[{"level":3,"title":"2.1 mysqldump","slug":"_2-1-mysqldump","link":"#_2-1-mysqldump","children":[]},{"level":3,"title":"2.2 xtrabackup","slug":"_2-2-xtrabackup","link":"#_2-2-xtrabackup","children":[]}]},{"level":2,"title":"3. 增量备份","slug":"_3-增量备份","link":"#_3-增量备份","children":[{"level":3,"title":"3.1 使用 xtrabackup 做增量备份","slug":"_3-1-使用-xtrabackup-做增量备份","link":"#_3-1-使用-xtrabackup-做增量备份","children":[]},{"level":3,"title":"3.2 使用 binlog 做增量备份","slug":"_3-2-使用-binlog-做增量备份","link":"#_3-2-使用-binlog-做增量备份","children":[]}]},{"level":2,"title":"4. 延迟同步","slug":"_4-延迟同步","link":"#_4-延迟同步","children":[]},{"level":2,"title":"5. 数据校验","slug":"_5-数据校验","link":"#_5-数据校验","children":[]},{"level":2,"title":"6. 总结","slug":"_6-总结","link":"#_6-总结","children":[]}],"git":{"createdTime":1754409177000,"updatedTime":1754409177000,"contributors":[{"name":"cangbao","email":"yph0228@163.com","commits":1}]},"readingTime":{"minutes":11.19,"words":3357},"filePathRelative":"notebook/mysql/MySQL备份策略.md","localizedDate":"2025年8月5日","autoDesc":true}');export{d as comp,r as data};
